- block:
               
  - name: Check data folders exist
    file: name={{ item }} state=directory
    with_items:
      - "{{ pyrdkafka_tmp_folder }}"
      - "{{ pyrdkafka_script_folder }}"

  - name: Copy configs
    copy: src=templates/{{ item }} dest={{ pyrdkafka_tmp_folder }}/{{ item }}
    with_items:
      - bulk.py
      - docker-compose.yml
      - simplethread.py
      - simplestaging.py
                             
  - name: Check server container running
    shell: docker inspect {{ pyrdkafka_tag }} | grep Running
    register: server_running
    ignore_errors: True

  - name: Stop server container
    shell: docker stop {{ pyrdkafka_tag }}
    ignore_errors: True
    when: "'true' in server_running.stdout"

  - name: Create pyrdkafka container
    shell: docker run 
      --rm 
      --name={{ pyrdkafka_tag }} 
      --detach=true
      --network="host"
      -e CONSUL_SERVER={{ consul_server_proxy_ip }}
      -e CONSUL_PORT={{ consul_port }}
      -e DBSOURCE="{{ dbsource }}"
      -v {{ pyrdkafka_tmp_folder }}/bulk.py:/app/index.py
      --log-driver=gelf 
      --log-opt gelf-address=udp://{{ graylog_ip }}:12201
      --log-opt tag="pyrdkafka-logs"
      "{{ acr_address }}/{{ docker_pyrdkafka_image }}:{{ pyrdkafka_docker_tag }}"
    register: result 

  - name: Save start script
    copy: content={{ result.cmd }} dest={{ pyrdkafka_script_folder }}/start_{{ pyrdkafka_tag }}.sh mode=a+x 
      
  tags: always
 
